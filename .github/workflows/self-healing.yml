name: ğŸ”§ Self-Healing Agent

on:
  workflow_dispatch:
  workflow_run:
    workflows:
      - "Test Self-Healing Agent"
      - "Gemini CLI - AI Code Assistant"
      - "Webhook Event Handler"
      - "Autonomous Agent Execution"
      - "State Machine Automation"
      - "Economic Circuit Breaker"
    types: [completed]

permissions:
  contents: write
  issues: write
  pull-requests: write
  actions: write
  workflows: write

jobs:
  detect-and-heal:
    name: ğŸš¨ Detect & Heal Failure
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get workflow file path
        id: get-workflow
        run: |
          WORKFLOW_NAME="${{ github.event.workflow_run.name }}"
          WORKFLOW_FILE=$(find .github/workflows -name "*.yml" -o -name "*.yaml" | xargs grep -l "name: ${WORKFLOW_NAME}" | head -1)

          if [ -z "$WORKFLOW_FILE" ]; then
            echo "workflow_file=.github/workflows/unknown.yml" >> $GITHUB_OUTPUT
            echo "workflow_exists=false" >> $GITHUB_OUTPUT
          else
            echo "workflow_file=${WORKFLOW_FILE}" >> $GITHUB_OUTPUT
            echo "workflow_exists=true" >> $GITHUB_OUTPUT
          fi

          echo "Workflow file: ${WORKFLOW_FILE}"

      - name: Get workflow logs
        id: get-logs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RUN_ID="${{ github.event.workflow_run.id }}"

          # Get failed jobs
          FAILED_JOBS=$(gh api "/repos/${{ github.repository }}/actions/runs/${RUN_ID}/jobs" \
            --jq '.jobs[] | select(.conclusion == "failure") | {name: .name, steps: [.steps[] | select(.conclusion == "failure") | {name: .name, number: .number}]}')

          # Save to file for Gemini
          echo "$FAILED_JOBS" > /tmp/failed_jobs.json

          # Get logs URL
          LOGS_URL="https://github.com/${{ github.repository }}/actions/runs/${RUN_ID}"
          echo "logs_url=${LOGS_URL}" >> $GITHUB_OUTPUT

          # Extract error summary
          ERROR_SUMMARY=$(echo "$FAILED_JOBS" | head -20)
          echo "error_summary<<EOF" >> $GITHUB_OUTPUT
          echo "$ERROR_SUMMARY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Issue for Failure
        id: create-issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          WORKFLOW_NAME: ${{ github.event.workflow_run.name }}
          RUN_ID: ${{ github.event.workflow_run.id }}
          RUN_URL: ${{ steps.get-logs.outputs.logs_url }}
          BRANCH: ${{ github.event.workflow_run.head_branch }}
          COMMIT: ${{ github.event.workflow_run.head_sha }}
          TRIGGER: ${{ github.event.workflow_run.event }}
          ACTOR: ${{ github.event.workflow_run.actor.login }}
          ERROR_SUMMARY: ${{ steps.get-logs.outputs.error_summary }}
          WORKFLOW_FILE: ${{ steps.get-workflow.outputs.workflow_file }}
          WORKFLOW_EXISTS: ${{ steps.get-workflow.outputs.workflow_exists }}
        run: |
          # Create issue body using environment variables
          cat > /tmp/issue_body.md << EOF
          ## ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚¨ãƒ©ãƒ¼æ¤œå‡º

          **ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼**: \`${WORKFLOW_NAME}\`
          **Run ID**: \`${RUN_ID}\`
          **Run URL**: ${RUN_URL}
          **Branch**: \`${BRANCH}\`
          **Commit**: \`${COMMIT}\`
          **ãƒˆãƒªã‚¬ãƒ¼**: \`${TRIGGER}\`
          **å®Ÿè¡Œè€…**: @${ACTOR}

          ### ã‚¨ãƒ©ãƒ¼æ¦‚è¦

          \`\`\`json
          ${ERROR_SUMMARY}
          \`\`\`

          ### ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«

          - **Path**: \`${WORKFLOW_FILE}\`
          - **Exists**: \`${WORKFLOW_EXISTS}\`

          ---

          ğŸ¤– **Self-Healing Agent ãŒè‡ªå‹•ä¿®å¾©ã‚’é–‹å§‹ã—ã¾ã—ãŸ**

          ã“ã®Issueã¯è‡ªå‹•ã§ã‚¯ãƒ­ãƒ¼ã‚ºã•ã‚Œã¾ã™ã€‚
          EOF

          # Create issue
          ISSUE_URL=$(gh issue create \
            --title "ğŸš¨ Self-Healing: ${WORKFLOW_NAME} failure" \
            --body-file /tmp/issue_body.md \
            --assignee "${ACTOR}")

          ISSUE_NUMBER=$(echo "$ISSUE_URL" | grep -oE '[0-9]+$')
          echo "issue-number=${ISSUE_NUMBER}" >> $GITHUB_OUTPUT
          echo "âœ… Created Issue #${ISSUE_NUMBER}"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Read workflow file
        id: read-workflow
        if: steps.get-workflow.outputs.workflow_exists == 'true'
        run: |
          WORKFLOW_FILE="${{ steps.get-workflow.outputs.workflow_file }}"
          WORKFLOW_CONTENT=$(cat "$WORKFLOW_FILE")

          echo "workflow_content<<EOF" >> $GITHUB_OUTPUT
          echo "$WORKFLOW_CONTENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Analyze and Fix with Gemini
        uses: google-github-actions/run-gemini-cli@v0.1.13
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          prompt: |
            # Self-Healing Agent - ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚¨ãƒ©ãƒ¼è‡ªå‹•ä¿®å¾©

            ## ã‚¨ãƒ©ãƒ¼æƒ…å ±

            **ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å**: ${{ github.event.workflow_run.name }}
            **Issue**: #${{ steps.create-issue.outputs.issue-number }}
            **Run URL**: ${{ steps.get-logs.outputs.logs_url }}

            ## å¤±æ•—ã—ãŸã‚¸ãƒ§ãƒ–

            ```json
            ${{ steps.get-logs.outputs.error_summary }}
            ```

            ## ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«

            **Path**: `${{ steps.get-workflow.outputs.workflow_file }}`

            ```yaml
            ${{ steps.read-workflow.outputs.workflow_content }}
            ```

            ## ã‚ãªãŸã®ãƒŸãƒƒã‚·ãƒ§ãƒ³

            1. **ã‚¨ãƒ©ãƒ¼åŸå› ã‚’ç‰¹å®š**
               - ãƒ­ã‚°ã‹ã‚‰å…·ä½“çš„ãªã‚¨ãƒ©ãƒ¼ã‚’æŠ½å‡º
               - ä¾å­˜é–¢ä¿‚ã®å•é¡Œã‹ã€è¨­å®šãƒŸã‚¹ã‹ã€ã‚³ãƒ¼ãƒ‰ãƒã‚°ã‹åˆ¤å®š

            2. **ä¿®å¾©æ–¹æ³•ã‚’æ±ºå®š**
               - ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ä¿®æ­£ãŒå¿…è¦ã‹
               - ã‚³ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ä¿®æ­£ãŒå¿…è¦ã‹
               - ä¾å­˜é–¢ä¿‚æ›´æ–°ãŒå¿…è¦ã‹

            3. **è‡ªå‹•ä¿®å¾©ã‚’å®Ÿè¡Œ**
               - å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†
               - ä¿®æ­£å†…å®¹ã‚’æ˜ç¢ºã«ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«è¨˜è¼‰
               - ãƒ†ã‚¹ãƒˆãŒé€šã‚‹ã“ã¨ã‚’ç¢ºèª

            ## åˆ¶ç´„æ¡ä»¶

            - æ—¢å­˜æ©Ÿèƒ½ã‚’å£Šã•ãªã„
            - TypeScript strict mode æº–æ‹ 
            - æœ€å°é™ã®å¤‰æ›´ã§ä¿®å¾©
            - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯ã‚’å°å…¥ã—ãªã„

            ## å‡ºåŠ›å½¢å¼

            ä¿®æ­£å†…å®¹ã‚’ JSON å½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼š

            ```json
            {
              "error_cause": "ã‚¨ãƒ©ãƒ¼ã®æ ¹æœ¬åŸå› ",
              "fix_type": "workflow|code|dependency",
              "files_to_modify": ["ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã®ãƒªã‚¹ãƒˆ"],
              "fix_description": "ä¿®æ­£å†…å®¹ã®èª¬æ˜",
              "test_commands": ["ãƒ†ã‚¹ãƒˆã‚³ãƒãƒ³ãƒ‰ã®ãƒªã‚¹ãƒˆ"]
            }
            ```

            ãã‚Œã§ã¯ã€è‡ªå¾‹çš„ã«ä¿®å¾©ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚

      - name: Install dependencies
        run: |
          npm ci
        continue-on-error: true

      - name: Run type check
        run: |
          npm run typecheck
        continue-on-error: true

      - name: Run tests
        run: |
          npm test
        continue-on-error: true

      - name: Create Pull Request
        id: create-pr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            fix(self-healing): Auto-fix ${{ github.event.workflow_run.name }} failure

            Fixes #${{ steps.create-issue.outputs.issue-number }}

            ğŸ¤– Self-Healing Agent ã«ã‚ˆã‚‹è‡ªå‹•ä¿®å¾©

            - ã‚¨ãƒ©ãƒ¼åŸå› ã‚’åˆ†æ
            - ä¿®å¾©ã‚³ãƒ¼ãƒ‰ã‚’è‡ªå‹•ç”Ÿæˆ
            - ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ¸ˆã¿

            Run URL: ${{ steps.get-logs.outputs.logs_url }}
          branch: self-healing/run-${{ github.event.workflow_run.id }}
          delete-branch: true
          title: "fix: Auto-heal ${{ github.event.workflow_run.name }} (#${{ steps.create-issue.outputs.issue-number }})"
          body: |
            ## ğŸ”§ Self-Healing Agent - è‡ªå‹•ä¿®å¾©å®Œäº†

            **Issue**: #${{ steps.create-issue.outputs.issue-number }}
            **Failed Workflow**: `${{ github.event.workflow_run.name }}`
            **Run ID**: `${{ github.event.workflow_run.id }}`
            **Run URL**: ${{ steps.get-logs.outputs.logs_url }}

            ---

            ### ğŸ” ã‚¨ãƒ©ãƒ¼åˆ†æ

            Gemini AI ãŒãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ­ã‚°ã¨ã‚³ãƒ¼ãƒ‰ã‚’åˆ†æã—ã¾ã—ãŸã€‚

            ### ğŸ› ï¸ ä¿®å¾©å†…å®¹

            è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸä¿®å¾©ã‚³ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚
            è©³ç´°ã¯ Commits ã‚¿ãƒ–ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

            ### âœ… æ¤œè¨¼çµæœ

            - Type check: See workflow logs
            - Tests: See workflow logs

            ---

            ğŸ¤– **ã“ã®PRã¯è‡ªå‹•ãƒãƒ¼ã‚¸ã•ã‚Œã¾ã™**

            Self-Healing Agent ã«ã‚ˆã‚‹å®Œå…¨è‡ªå¾‹ä¿®å¾©ã€‚
            å•é¡ŒãŒã‚ã‚‹å ´åˆã¯ã€ã“ã®PRã‚’ã‚¯ãƒ­ãƒ¼ã‚ºã—ã¦æ‰‹å‹•ã§ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚

            ---

            Generated by Self-Healing Agent
            Co-Authored-By: Gemini AI <noreply@google.com>
          draft: false

      - name: Wait for PR checks
        if: steps.create-pr.outputs.pull-request-number != ''
        run: |
          echo "Waiting 30 seconds for PR checks to start..."
          sleep 30

      - name: Auto-merge PR
        if: steps.create-pr.outputs.pull-request-number != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ steps.create-pr.outputs.pull-request-number }}"

          echo "ğŸ¤– Auto-merging PR #${PR_NUMBER}..."

          # Enable auto-merge with squash
          gh pr merge "${PR_NUMBER}" \
            --auto \
            --squash \
            --delete-branch \
            --body "ğŸ¤– Auto-merged by Self-Healing Agent" || {
              echo "âš ï¸ Auto-merge failed. PR requires manual review."
              gh pr comment "${PR_NUMBER}" --body "âš ï¸ è‡ªå‹•ãƒãƒ¼ã‚¸ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒå¿…è¦ã§ã™ã€‚"
              exit 0
            }

          echo "âœ… Auto-merge enabled for PR #${PR_NUMBER}"

      - name: Close Issue
        if: steps.create-pr.outputs.pull-request-number != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUMBER="${{ steps.create-issue.outputs.issue-number }}"
          PR_NUMBER="${{ steps.create-pr.outputs.pull-request-number }}"

          gh issue comment "${ISSUE_NUMBER}" --body "âœ… è‡ªå‹•ä¿®å¾©å®Œäº†ã€‚PR #${PR_NUMBER} ã§ä¿®æ­£ã•ã‚Œã¾ã—ãŸã€‚"
          gh issue close "${ISSUE_NUMBER}" --reason "completed"

          echo "âœ… Issue #${ISSUE_NUMBER} closed"

      - name: Notify on failure
        if: failure()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUMBER="${{ steps.create-issue.outputs.issue-number }}"

          gh issue comment "${ISSUE_NUMBER}" --body "âŒ è‡ªå‹•ä¿®å¾©ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§ã®å¯¾å¿œãŒå¿…è¦ã§ã™ã€‚"

          echo "âŒ Self-healing failed. Manual intervention required."
