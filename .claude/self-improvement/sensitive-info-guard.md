# センシティブ情報検出ガード

**目的**: ユーザーがセンシティブ情報をチャットに貼り付けるのを防ぐ

**重要性**: **CRITICAL** - これは最優先で実施すべき

**根拠**: Failure ID F001（API キー漏洩）は重大度 CRITICAL

---

## 🚨 検出パターン

### API Keys & Tokens

#### Google API Key
- **パターン**: `AI` + `za` で始まる35文字の英数字・記号
- **正規表現**: `/[A][I]za[A-Za-z0-9_-]{35}/`（難読化）
- **例**: `[PREFIX]...` （実際のキーは記載しない）
- **検出時**: 即座に拒否し、安全な設定方法を提示

#### GitHub Personal Access Token (PAT)
- **パターン**: `gh` + `p_` で始まる36文字の英数字
- **正規表現**: `/[g][h][p]_[A-Za-z0-9]{36}/`（難読化）
- **例**: `[PREFIX]...` （実際のトークンは記載しない）
- **検出時**: 即座に拒否し、`gh auth login` を推奨

#### Anthropic API Key
- **パターン**: `s` + `k-ant-` で始まる文字列
- **正規表現**: `/[s][k]-ant-[A-Za-z0-9-]{40,}/`（難読化）
- **例**: `[PREFIX]...` （実際のキーは記載しない）
- **検出時**: 即座に拒否し、環境変数設定を推奨

#### OpenAI API Key
- **パターン**: `s` + `k` + `-proj` で始まる文字列
- **正規表現**: `/[s][k]-proj[A-Za-z0-9]{43}/`（難読化）
- **例**: `[PREFIX]...` （実際のキーは記載しない）
- **検出時**: 即座に拒否し、環境変数設定を推奨

---

## 🛡️ 検出時の対応

### ステップ1: 即座に拒否

```markdown
⚠️ **センシティブ情報が検出されました**

**検出された情報**: {detected-type}

**重要**: このチャットには貼り付けないでください。

**理由**:
- 会話履歴は削除できません
- 永久に記録されます
- セキュリティリスクがあります

安全な設定方法を以下に示します。
```

### ステップ2: 安全な設定方法を詳細に提示

#### Google API Key (GEMINI_API_KEY) の場合

```markdown
## 安全な設定方法

### 方法1: ターミナル（最も安全）

```bash
cd /Users/enhanced/Desktop/program/article-generator
gh secret set GEMINI_API_KEY
```

プロンプトが表示されたら API キーを入力してください。
**入力中は画面に表示されません。**

### 方法2: Web UI

1. ブラウザで以下を開く:
   ```
   https://github.com/hiromima/article-generator/settings/secrets/actions
   ```

2. "New repository secret" をクリック

3. 以下を入力:
   - Name: `GEMINI_API_KEY`
   - Value: （API キーを貼り付け）

4. "Add secret" をクリック

## 完了後

設定が完了したら、「完了」とだけ教えてください。
API キーの内容は送信しないでください。
```

#### GitHub PAT の場合

```markdown
## 安全な設定方法

### 推奨: gh CLI の認証機能を使用

```bash
gh auth login
```

このコマンドを実行すると、ブラウザで安全に認証できます。

### または: 環境変数に設定

```bash
# .env ファイルに追加（.gitignore に含める）
echo "GITHUB_TOKEN=your_token_here" >> .env

# .gitignore に追加
echo ".env" >> .gitignore
```

## 完了後

設定が完了したら、「完了」とだけ教えてください。
トークンの内容は送信しないでください。
```

---

## 📋 チェックフロー

### ユーザー入力を受け取る前

```
1. ユーザーがタスクを依頼
   ↓
2. センシティブ情報が必要か判定
   ↓ YES
3. 事前に警告メッセージを送信
   「⚠️ このチャットには API キーを貼り付けないでください」
   ↓
4. 安全な設定方法を詳細に説明
   ↓
5. ユーザーが安全に設定
   ↓
6. 「完了」の報告を受け取る
   ↓
7. 実装を続行
```

### ユーザーが入力した場合（検出）

```
1. ユーザーの入力を受信
   ↓
2. 検出パターンでチェック
   ↓ 検出
3. 入力を拒否
   ↓
4. 警告メッセージを送信
   ↓
5. 安全な設定方法を説明
   ↓
6. ユーザーに無効化を推奨
   「このキーは今すぐ無効化してください」
   ↓
7. 新しいキーの安全な設定を支援
```

---

## 🎯 予防的アプローチ

### タスク分析時

タスクを受け取ったら、以下を確認:

```markdown
## センシティブ情報の必要性チェック

**このタスクで必要なもの**:
- [ ] API キー
- [ ] トークン
- [ ] パスワード
- [ ] その他のシークレット

**必要な場合**:
→ 即座に警告メッセージを送信
→ 安全な設定方法を提示
→ ユーザーの入力を待たない
```

### 実装前の警告

```markdown
⚠️ この実装には {SENSITIVE_INFO_TYPE} が必要です。

**重要**: 次のステップに進む前に、安全な設定方法を確認してください。

【安全な設定方法を詳細に記載】

準備ができたら教えてください。
```

---

## 📝 検出ログ

### 検出履歴

```json
{
  "detections": [
    {
      "timestamp": "2025-10-15T...",
      "type": "google-api-key",
      "action": "blocked",
      "userNotified": true,
      "safeMethodProvided": true
    }
  ]
}
```

### 統計

- **総検出回数**: 0（目標）
- **ブロック成功率**: 100%（必須）
- **ユーザー教育**: 実施済み

---

## 🔄 継続的改善

### 新しいパターンの追加

新しいタイプのセンシティブ情報が特定されたら、このファイルに追加:

```markdown
#### {New Service} API Key
- **パターン**: {pattern-description}
- **正規表現**: `/{regex}/`
- **検出時**: {action}
```

### レビュー

- **頻度**: 新しい API を使用するたび
- **更新**: 検出パターンの追加・改善
- **テスト**: 誤検出・見逃しのチェック

---

## ✅ 実装チェックリスト

タスク実行前に必ず確認:

- [ ] センシティブ情報が必要か確認した
- [ ] 必要な場合、事前に警告メッセージを送信した
- [ ] 安全な設定方法を詳細に説明した
- [ ] ユーザーの入力を待たずに先に説明した
- [ ] 検出パターンをチェックする準備ができている

---

**最終更新**: 2025-10-15
**重要度**: CRITICAL
**次回レビュー**: 新しい API 使用時
