# Self-Healing Agent ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

Self-Healing Agent ã®è©³ç´°ãªã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆã‚’èª¬æ˜ã—ã¾ã™ã€‚

## ğŸ“‹ ç›®æ¬¡

- [ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦](#ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦)
- [ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³](#ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³)
- [ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè©³ç´°](#ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè©³ç´°)
- [ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼](#ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼)
- [ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°](#ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°)
- [æ‹¡å¼µæ€§](#æ‹¡å¼µæ€§)

## ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦

Self-Healing Agent ã¯ä»¥ä¸‹ã®è¨­è¨ˆåŸå‰‡ã«åŸºã¥ã„ã¦æ§‹ç¯‰ã•ã‚Œã¦ã„ã¾ã™:

### è¨­è¨ˆåŸå‰‡

1. **å®Œå…¨è‡ªå¾‹å‹•ä½œ** - äººé–“ã®ä»‹å…¥ãªã—ã§å‹•ä½œ
2. **ãƒ¢ã‚¸ãƒ¥ãƒ©ãƒ¼è¨­è¨ˆ** - å„ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ç‹¬ç«‹ã—ã¦ãƒ†ã‚¹ãƒˆå¯èƒ½
3. **ã‚¨ãƒ©ãƒ¼é€æ˜æ€§** - å…¨ã¦ã®ã‚¨ãƒ©ãƒ¼ã‚’ãƒ­ã‚°ã¨ã—ã¦è¨˜éŒ²
4. **æ®µéšçš„ä¿®å¾©** - å¤±æ•—æ™‚ã¯æ®µéšçš„ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
5. **ãƒ†ã‚¹ã‚¿ãƒ“ãƒªãƒ†ã‚£** - 100% ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸

### ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆè¦ç´ 

```
Self-Healing Agent
â”œâ”€â”€ Trigger System (workflow_run)
â”œâ”€â”€ Detection Layer (get-workflow-path, get-logs)
â”œâ”€â”€ Analysis Layer (Gemini AI)
â”œâ”€â”€ Repair Layer (Code Generation)
â”œâ”€â”€ Validation Layer (Tests, Type Check)
â””â”€â”€ Integration Layer (PR, Auto-merge)
```

## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³

### å…¨ä½“ãƒ•ãƒ­ãƒ¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Monitored Workflows                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚Test   â”‚  â”‚Gemini â”‚  â”‚Webhookâ”‚  â”‚Agent  â”‚  â”‚State  â”‚   â”‚
â”‚  â”‚Self   â”‚  â”‚CLI    â”‚  â”‚Event  â”‚  â”‚Exec   â”‚  â”‚Machineâ”‚   â”‚
â”‚  â””â”€â”€â”€â”¬â”€â”€â”€â”˜  â””â”€â”€â”€â”¬â”€â”€â”€â”˜  â””â”€â”€â”€â”¬â”€â”€â”€â”˜  â””â”€â”€â”€â”¬â”€â”€â”€â”˜  â””â”€â”€â”€â”¬â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚          â”‚          â”‚          â”‚          â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚ (failure)
                         â†“
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚     Self-Healing Agent (workflow_run)   â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â†“               â†“               â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚Detect  â”‚     â”‚Analyze  â”‚    â”‚Repair    â”‚
    â”‚& Track â”‚ â†’   â”‚with AI  â”‚ â†’  â”‚& Validateâ”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚               â”‚               â”‚
         â†“               â†“               â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚Create  â”‚     â”‚Generate â”‚    â”‚Create PR â”‚
    â”‚Issue   â”‚     â”‚Fix Code â”‚    â”‚Auto-mergeâ”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæ§‹æˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             .github/workflows/self-healing.yml          â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                   Trigger Layer                  â”‚  â”‚
â”‚  â”‚  on:                                             â”‚  â”‚
â”‚  â”‚    workflow_run:                                 â”‚  â”‚
â”‚  â”‚      workflows: [...]                            â”‚  â”‚
â”‚  â”‚      types: [completed]                          â”‚  â”‚
â”‚  â”‚    if: conclusion == 'failure'                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                        â†“                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                 Detection Layer                  â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚
â”‚  â”‚  â”‚ scripts/self-healing/                   â”‚    â”‚  â”‚
â”‚  â”‚  â”‚  â”œâ”€â”€ get-workflow-path.sh  (5 tests)   â”‚    â”‚  â”‚
â”‚  â”‚  â”‚  â”œâ”€â”€ get-workflow-logs.sh  (7 tests)   â”‚    â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€ read-workflow.sh      (6 tests)   â”‚    â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                        â†“                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                  Analysis Layer                  â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚
â”‚  â”‚  â”‚ google-github-actions/run-gemini-cli    â”‚    â”‚  â”‚
â”‚  â”‚  â”‚  - Error analysis                        â”‚    â”‚  â”‚
â”‚  â”‚  â”‚  - Root cause identification             â”‚    â”‚  â”‚
â”‚  â”‚  â”‚  - Fix strategy determination            â”‚    â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                        â†“                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                  Repair Layer                    â”‚  â”‚
â”‚  â”‚  - npm install (dependencies)                    â”‚  â”‚
â”‚  â”‚  - npm run typecheck                             â”‚  â”‚
â”‚  â”‚  - npm test                                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                        â†“                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                Integration Layer                 â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚
â”‚  â”‚  â”‚ peter-evans/create-pull-request         â”‚    â”‚  â”‚
â”‚  â”‚  â”‚  - Branch: self-healing/run-{id}        â”‚    â”‚  â”‚
â”‚  â”‚  â”‚  - Auto-merge: enabled                   â”‚    â”‚  â”‚
â”‚  â”‚  â”‚  - Issue reference: Fixes #{issue}      â”‚    â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè©³ç´°

### 1. Trigger System

**è²¬å‹™**: ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å¤±æ•—ã‚’æ¤œçŸ¥ã— Self-Healing Agent ã‚’èµ·å‹•

**å®Ÿè£…**:
```yaml
on:
  workflow_run:
    workflows:
      - "Test Self-Healing Agent"
      - "Gemini CLI - AI Code Assistant"
      # ... other workflows
    types: [completed]

jobs:
  detect-and-heal:
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
```

**ç‰¹å¾´**:
- `workflow_run` ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä½¿ç”¨
- main ãƒ–ãƒ©ãƒ³ãƒã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®ã¿ç›£è¦–
- å¤±æ•—æ™‚ã®ã¿å®Ÿè¡Œï¼ˆæˆåŠŸæ™‚ã¯ã‚¹ã‚­ãƒƒãƒ—ï¼‰

**åˆ¶ç´„**:
- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ–ãƒ©ãƒ³ãƒï¼ˆmainï¼‰ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®ã¿ãƒˆãƒªã‚¬ãƒ¼å¯èƒ½
- ãƒ•ã‚©ãƒ¼ã‚¯ã‹ã‚‰ã® PR ã§ã¯å‹•ä½œã—ãªã„

### 2. Detection Layer

#### get-workflow-path.sh

**è²¬å‹™**: ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼åã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’ç‰¹å®š

**å…¥åŠ›**:
- `WORKFLOW_NAME`: å¤±æ•—ã—ãŸãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®åå‰

**å‡ºåŠ›**:
- `workflow_file`: ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹
- `workflow_exists`: ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ï¼ˆtrue/falseï¼‰

**å®Ÿè£…**: scripts/self-healing/get-workflow-path.sh:1

```bash
WORKFLOW_FILE=$(find .github/workflows \( -name "*.yml" -o -name "*.yaml" \) -print0 2>/dev/null | \
    xargs -0 grep -l "^name: ${WORKFLOW_NAME}$" 2>/dev/null | head -1 || echo "")
```

**ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹**:
- ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒå­˜åœ¨ã—ãªã„ â†’ `workflow_exists=false`
- è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã«åŒåãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ â†’ æœ€åˆã®ãƒãƒƒãƒã‚’è¿”ã™
- ã‚¹ãƒšãƒ¼ã‚¹ã‚’å«ã‚€ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å â†’ æ­£ç¢ºã«ãƒãƒƒãƒ

**ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸**: 5/5 tests âœ…

#### get-workflow-logs.sh

**è²¬å‹™**: å¤±æ•—ã—ãŸãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®ãƒ­ã‚°ã‚’å–å¾—

**å…¥åŠ›**:
- `RUN_ID`: ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œ ID
- `REPOSITORY`: ãƒªãƒã‚¸ãƒˆãƒªåï¼ˆowner/repoï¼‰

**å‡ºåŠ›**:
- `logs_url`: ãƒ­ã‚°ã® URL
- `error_summary`: ã‚¨ãƒ©ãƒ¼ã‚µãƒãƒªãƒ¼ï¼ˆ20è¡Œã¾ã§ï¼‰
- `/tmp/failed_jobs.json`: å¤±æ•—ã—ãŸã‚¸ãƒ§ãƒ–ã®è©³ç´°

**å®Ÿè£…**: scripts/self-healing/get-workflow-logs.sh:1

```bash
FAILED_JOBS=$(gh api "/repos/${REPOSITORY}/actions/runs/${RUN_ID}/jobs" \
  --jq '.jobs[] | select(.conclusion == "failure") | {name: .name, steps: [...]}')
```

**ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹**:
- API ã‚¨ãƒ©ãƒ¼ â†’ exit 1
- ç©ºã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ â†’ ç©ºã®ã‚µãƒãƒªãƒ¼ã‚’è¿”ã™
- 20è¡Œè¶…ã®ãƒ­ã‚° â†’ å…ˆé ­20è¡Œã®ã¿

**ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸**: 7/7 tests âœ…

#### read-workflow.sh

**è²¬å‹™**: ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’èª­ã¿è¾¼ã¿

**å…¥åŠ›**:
- `WORKFLOW_FILE`: ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹

**å‡ºåŠ›**:
- `workflow_content`: ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹

**å®Ÿè£…**: scripts/self-healing/read-workflow.sh:1

```bash
WORKFLOW_CONTENT=$(cat "$WORKFLOW_FILE")
```

**ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹**:
- ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„ â†’ exit 1
- ç©ºã®ãƒ•ã‚¡ã‚¤ãƒ« â†’ ç©ºã®å†…å®¹ã‚’è¿”ã™
- å¤§å®¹é‡ãƒ•ã‚¡ã‚¤ãƒ« â†’ å…¨ã¦èª­ã¿è¾¼ã¿

**ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸**: 6/6 tests âœ…

### 3. Analysis Layer

#### Gemini AI Integration

**è²¬å‹™**: ã‚¨ãƒ©ãƒ¼ã‚’åˆ†æã—ä¿®å¾©æ–¹æ³•ã‚’æ±ºå®š

**å®Ÿè£…**:
```yaml
- name: Analyze and Fix with Gemini
  uses: google-github-actions/run-gemini-cli@v0.1.13
  with:
    gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
    prompt: |
      # ã‚¨ãƒ©ãƒ¼æƒ…å ±ã¨ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æä¾›
      # AI ãŒä¿®å¾©æ–¹æ³•ã‚’æ±ºå®š
```

**å…¥åŠ›**:
- ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å
- ã‚¨ãƒ©ãƒ¼ã‚µãƒãƒªãƒ¼
- ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹

**å‡ºåŠ›**:
- ã‚¨ãƒ©ãƒ¼åŸå› 
- ä¿®å¾©ã‚¿ã‚¤ãƒ—ï¼ˆworkflow/code/dependencyï¼‰
- ä¿®æ­£å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆ
- ãƒ†ã‚¹ãƒˆã‚³ãƒãƒ³ãƒ‰

**AI ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ§‹é€ **:
1. **ã‚¨ãƒ©ãƒ¼æƒ…å ±** - å¤±æ•—ã—ãŸã‚¸ãƒ§ãƒ–ã¨ã‚¹ãƒ†ãƒƒãƒ—
2. **ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«** - ç¾åœ¨ã®è¨­å®š
3. **ãƒŸãƒƒã‚·ãƒ§ãƒ³** - ä¿®å¾©ã®å…·ä½“çš„æ‰‹é †
4. **åˆ¶ç´„æ¡ä»¶** - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã€æ—¢å­˜æ©Ÿèƒ½ä¿è­·
5. **å‡ºåŠ›å½¢å¼** - JSON å½¢å¼ã§ã®ä¿®å¾©è¨ˆç”»

### 4. Repair Layer

#### ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```yaml
- name: Install dependencies
  run: npm ci
  continue-on-error: true
```

å¤±æ•—ã—ã¦ã‚‚ç¶™ç¶šï¼ˆä¾å­˜é–¢ä¿‚ã®å•é¡ŒãŒåŸå› ã§ãªã„å ´åˆãŒã‚ã‚‹ï¼‰

#### å‹ãƒã‚§ãƒƒã‚¯

```yaml
- name: Run type check
  run: npm run typecheck
  continue-on-error: true
```

TypeScript strict mode ã§ã®æ¤œè¨¼

#### ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ

```yaml
- name: Run tests
  run: npm test
  continue-on-error: true
```

å…¨ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œã¨ã‚«ãƒãƒ¬ãƒƒã‚¸ç¢ºèª

### 5. Integration Layer

#### PR ä½œæˆ

**è²¬å‹™**: ä¿®å¾©ã‚³ãƒ¼ãƒ‰ã‚’å«ã‚€ PR ã‚’è‡ªå‹•ä½œæˆ

**å®Ÿè£…**:
```yaml
- name: Create Pull Request
  uses: peter-evans/create-pull-request@v6
  with:
    token: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
    branch: self-healing/run-${{ github.event.workflow_run.id }}
    title: "fix: Auto-heal ..."
    body: |
      ## ä¿®å¾©å†…å®¹
      - ã‚¨ãƒ©ãƒ¼åˆ†æçµæœ
      - ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«
      - ãƒ†ã‚¹ãƒˆçµæœ
```

**ç‰¹å¾´**:
- Conventional Commits æº–æ‹ 
- Issue å‚ç…§ï¼ˆFixes #123ï¼‰
- Draft PR ã¨ã—ã¦ä½œæˆ
- è‡ªå‹•å‰Šé™¤ãƒ–ãƒ©ãƒ³ãƒ

#### Auto-merge

**è²¬å‹™**: ãƒ†ã‚¹ãƒˆé€šéå¾Œã«è‡ªå‹•ãƒãƒ¼ã‚¸

**å®Ÿè£…**:
```yaml
- name: Auto-merge PR
  run: |
    gh pr merge "${PR_NUMBER}" \
      --auto \
      --squash \
      --delete-branch
```

**æ¡ä»¶**:
- å…¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒã‚§ãƒƒã‚¯ãŒãƒ‘ã‚¹
- ãƒ–ãƒ©ãƒ³ãƒä¿è­·ãƒ«ãƒ¼ãƒ«æº–æ‹ 
- Auto-merge æ©Ÿèƒ½ãŒæœ‰åŠ¹

## ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

### æˆåŠŸæ™‚ã®ãƒ•ãƒ­ãƒ¼

```
1. Workflow Failure
   â†“
2. workflow_run Event (conclusion: failure)
   â†“
3. Self-Healing Agent Start
   â†“
4. Get Workflow Path
   â†’ workflow_file=".github/workflows/test.yml"
   â†’ workflow_exists=true
   â†“
5. Get Workflow Logs
   â†’ logs_url="https://github.com/..."
   â†’ error_summary="..."
   â†’ /tmp/failed_jobs.json
   â†“
6. Create Issue
   â†’ issue-number=123
   â†“
7. Read Workflow File
   â†’ workflow_content="..."
   â†“
8. Analyze with Gemini
   â†’ error_cause="..."
   â†’ fix_type="code"
   â†’ files_to_modify=[...]
   â†“
9. Generate Fix Code (by Gemini)
   â†“
10. Install Dependencies
   â†’ npm ci (success/continue)
   â†“
11. Run Type Check
   â†’ npm run typecheck (success/continue)
   â†“
12. Run Tests
   â†’ npm test (success/continue)
   â†“
13. Create PR
   â†’ pull-request-number=456
   â†“
14. Wait for Checks
   â†’ 30 seconds
   â†“
15. Enable Auto-merge
   â†’ gh pr merge --auto
   â†“
16. Close Issue
   â†’ gh issue close 123
   â†“
17. Success! ğŸ‰
```

### ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ•ãƒ­ãƒ¼

```
1. Workflow Failure
   â†“
2. Self-Healing Agent Start
   â†“
3. Detection Layer Error
   â†’ Create Issue (if possible)
   â†’ Notify Failure
   â†’ Exit 1
```

å„ã‚¹ãƒ†ãƒƒãƒ—ã§ `trap` ã¨ `set -euo pipefail` ã«ã‚ˆã‚Šã‚¨ãƒ©ãƒ¼ã‚’ã‚­ãƒ£ãƒƒãƒ

## ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

### ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°æˆ¦ç•¥

1. **Bash strict mode**
   ```bash
   set -euo pipefail
   trap 'echo "::error::Failed at line $LINENO"' ERR
   ```

2. **æ®µéšçš„ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯**
   - Step 1 å¤±æ•— â†’ Issue ä½œæˆã—ã¦é€šçŸ¥
   - Step 2 å¤±æ•— â†’ æ—¢å­˜ Issue ã«è¿½è¨˜
   - Step 3 å¤±æ•— â†’ æ‰‹å‹•å¯¾å¿œã‚’ä¿ƒã™

3. **continue-on-error**
   - ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«: å¤±æ•—ã—ã¦ã‚‚ç¶™ç¶š
   - å‹ãƒã‚§ãƒƒã‚¯: å¤±æ•—ã—ã¦ã‚‚ç¶™ç¶š
   - ãƒ†ã‚¹ãƒˆ: å¤±æ•—ã—ã¦ã‚‚ç¶™ç¶šï¼ˆPR ã¯ä½œæˆï¼‰

4. **é€šçŸ¥ãƒ¡ã‚«ãƒ‹ã‚ºãƒ **
   ```yaml
   - name: Notify on failure
     if: failure()
     run: |
       gh issue comment "${ISSUE_NUMBER}" --body "âŒ è‡ªå‹•ä¿®å¾©ã«å¤±æ•—ã—ã¾ã—ãŸ"
   ```

### ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°å½¢å¼

**GitHub Actions annotations**:
- `::error::` - ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
- `::warning::` - è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
- `::notice::` - æƒ…å ±ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

## æ‹¡å¼µæ€§

### æ–°ã—ã„ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®è¿½åŠ 

`.github/workflows/self-healing.yml` ã® `on.workflow_run.workflows` ã«è¿½åŠ :

```yaml
on:
  workflow_run:
    workflows:
      - "Existing Workflow"
      - "New Workflow Name"  # â† è¿½åŠ 
    types: [completed]
```

### æ–°ã—ã„ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®è¿½åŠ 

1. `scripts/self-healing/new-script.sh` ã‚’ä½œæˆ
2. `tests/self-healing/new-script.bats` ã§ãƒ†ã‚¹ãƒˆ
3. `.github/workflows/self-healing.yml` ã§å‘¼ã³å‡ºã—

```yaml
- name: Run new script
  run: bash scripts/self-healing/new-script.sh <args>
```

### ã‚«ã‚¹ã‚¿ãƒ  AI ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®è¿½åŠ 

`.github/workflows/self-healing.yml` ã® Gemini ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º:

```yaml
- name: Analyze and Fix with Gemini
  uses: google-github-actions/run-gemini-cli@v0.1.13
  with:
    prompt: |
      # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå›ºæœ‰ã®æƒ…å ±ã‚’è¿½åŠ 
      ## ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒ«
      - ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ã‚¿ã‚¤ãƒ«: Prettier
      - ãƒ†ã‚¹ãƒˆãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯: Jest
      - ã‚«ãƒãƒ¬ãƒƒã‚¸ç›®æ¨™: 80%+

      # ... æ—¢å­˜ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
```

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹

### å®Ÿè¡Œæ™‚é–“

- **Detection Layer**: ~5ç§’
- **Analysis Layer**: ~15-30ç§’ï¼ˆGemini APIï¼‰
- **Repair Layer**: ~30-60ç§’ï¼ˆnpm install, testsï¼‰
- **Integration Layer**: ~10ç§’

**åˆè¨ˆ**: ç´„ 1-2 åˆ†

### API ä½¿ç”¨é‡

- **GitHub API**: 5-10 requests/run
- **Gemini API**: 1-2 requests/run

**æœˆé–“ã‚³ã‚¹ãƒˆ**: Â¥0ï¼ˆç„¡æ–™æ å†…ï¼‰

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

### æ©Ÿå¯†æƒ…å ±ã®ä¿è­·

1. **ç’°å¢ƒå¤‰æ•°**
   - `GEMINI_API_KEY` - GitHub Secrets
   - `PAT_TOKEN` - GitHub Secrets
   - `GITHUB_TOKEN` - è‡ªå‹•æä¾›ï¼ˆèª­ã¿å–ã‚Šå°‚ç”¨æ¨å¥¨ï¼‰

2. **ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼åˆ¶ç´„**
   - ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«è‡ªä½“ã¯å¤‰æ›´ç¦æ­¢
   - ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ã®ã¿ä¿®æ­£

3. **æ¨©é™æœ€å°åŒ–**
   ```yaml
   permissions:
     contents: write        # ã‚³ãƒ¼ãƒ‰å¤‰æ›´ã®ã¿
     issues: write          # Issue ç®¡ç†ã®ã¿
     pull-requests: write   # PR ç®¡ç†ã®ã¿
     actions: write         # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œã®ã¿
   ```

## ã¾ã¨ã‚

Self-Healing Agent ã¯ä»¥ä¸‹ã®ç‰¹å¾´ã‚’æŒã¤ãƒ¢ã‚¸ãƒ¥ãƒ©ãƒ¼ã§æ‹¡å¼µå¯èƒ½ãªã‚·ã‚¹ãƒ†ãƒ ã§ã™:

- âœ… **å®Œå…¨è‡ªå¾‹å‹•ä½œ** - äººé–“ã®ä»‹å…¥ä¸è¦
- âœ… **100% ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸** - å…¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒãƒ†ã‚¹ãƒˆæ¸ˆã¿
- âœ… **AI é§†å‹•ä¿®å¾©** - Gemini ã«ã‚ˆã‚‹æ ¹æœ¬åŸå› åˆ†æ
- âœ… **æ®µéšçš„ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°** - å¤±æ•—æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
- âœ… **æ‹¡å¼µæ€§** - æ–°ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ»ã‚¹ã‚¯ãƒªãƒ—ãƒˆè¿½åŠ ãŒå®¹æ˜“

---

ğŸ“˜ [README ã«æˆ»ã‚‹](./README.md) | ğŸ”§ [ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°](./TROUBLESHOOTING.md)
